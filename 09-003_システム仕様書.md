### 文書番号: 09-003-SPEC

# 天気予報＋服装提案掲示板アプリ システム仕様書

## 1. 文書情報

| 項目 | 内容 |
|------|------|
| 文書番号 | 09-003-SPEC |
| 対象システム | 天気予報＋服装提案掲示板アプリ |
| 対象ファイル | `weather_outfit_advisor.py` |
| 関連要件定義書 | 09-003_天気予報＋服装提案掲示板アプリ_要件定義書.md |
| 作成日 | 2025年12月30日 |
| 版数 | 2.0（ライブラリ参照形式） |

---

## 2. システム概要

### 2.1 目的
OpenWeatherMap APIから取得した天気情報を基に、OpenAI API（gpt-5-mini）で服装アドバイスを生成し、SSD1306 OLEDディスプレイに日本語で横スクロール表示するシステム。

### 2.2 システム構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                      Raspberry Pi 5                              │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              weather_outfit_advisor.py                     │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │           WeatherOutfitAdvisor クラス                │  │  │
│  │  │                                                      │  │  │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────────────┐  │  │  │
│  │  │  │ 天気取得  │→│ AI生成   │→│ OLED表示          │  │  │  │
│  │  │  │          │  │          │  │ (OLEDScroller)   │  │  │  │
│  │  │  └────┬─────┘  └────┬─────┘  └────────┬─────────┘  │  │  │
│  │  └───────┼─────────────┼─────────────────┼────────────┘  │  │
│  └──────────┼─────────────┼─────────────────┼───────────────┘  │
│             │             │                 │                   │
│             ▼             ▼                 ▼                   │
│     ┌───────────┐  ┌───────────┐     ┌───────────┐             │
│     │ requests  │  │  openai   │     │scroll_oled│             │
│     └─────┬─────┘  └─────┬─────┘     │ (Library) │             │
│           │              │           └─────┬─────┘             │
└───────────┼──────────────┼─────────────────┼───────────────────┘
            │              │                 │
            ▼              ▼                 ▼
    ┌───────────────┐ ┌──────────┐    ┌─────────────┐
    │ OpenWeatherMap│ │ OpenAI   │    │ SSD1306     │
    │ API           │ │ API      │    │ OLED (I²C)  │
    └───────────────┘ └──────────┘    └─────────────┘
```

---

## 3. ファイル構成

### 3.1 プロジェクト構造

```
09-003-weather-outfit-advisor/
├── weather_outfit_advisor.py      # メインプログラム（OLED版）
├── weather_outfit_advisor_full.py # バックアップ（編集禁止）
├── weather_outfit_advisor_console.py # コンソール版
├── scroll_oled.py                 # OLEDスクロール表示ライブラリ
├── .env                           # 環境変数（APIキー等）
├── .env.example                   # 環境変数テンプレート
├── requirements.txt               # 依存ライブラリ
├── weather_outfit.log             # 実行ログ
├── assets/
│   └── fonts/
│       └── NotoSansCJKjp-Regular.otf  # 日本語フォント
└── reference/                     # 参照データ（読み取り専用）
    └── 06-004-ssd1306-oled-jp-display/
```

### 3.2 ファイル依存関係

```
weather_outfit_advisor.py
    ├── scroll_oled.py (import OLEDScroller)
    │       └── luma.oled, Pillow
    ├── openai
    ├── requests
    └── python-dotenv
```

---

## 4. クラス・モジュール仕様

### 4.1 weather_outfit_advisor.py

#### WeatherOutfitAdvisor クラス

| 項目 | 内容 |
|------|------|
| 責務 | 天気取得→服装アドバイス生成→OLED表示の統合制御 |
| 依存 | OLEDScroller, openai, requests |

##### 属性一覧

| 属性名 | 型 | 説明 | 初期値ソース |
|--------|-----|------|-------------|
| `weather_api_key` | str | OpenWeatherMap APIキー | 環境変数 `WEATHER_API_KEY` |
| `openai_api_key` | str | OpenAI APIキー | 環境変数 `OPENAI_API_KEY` |
| `city_name` | str | 対象都市名 | 環境変数 `CITY_NAME` (default: Tokyo) |
| `oled_width` | int | OLED画面幅 | 環境変数 `OLED_WIDTH` (default: 128) |
| `oled_height` | int | OLED画面高さ | 環境変数 `OLED_HEIGHT` (default: 64) |
| `oled_i2c_address` | int | I²Cアドレス | 環境変数 `OLED_I2C_ADDRESS` (default: 0x3C) |
| `font_path` | str | フォントパス | 環境変数 `FONT_PATH` |
| `font_size` | int | フォントサイズ | 環境変数 `FONT_SIZE` (default: 14) |
| `scroll_speed` | int | スクロール速度(px/frame) | 環境変数 `SCROLL_SPEED_PX` (default: 2) |
| `frame_delay` | float | フレーム間隔(秒) | 環境変数 `FRAME_DELAY_SEC` (default: 0.05) |
| `openai_client` | OpenAI | OpenAI APIクライアント | - |
| `scroller` | OLEDScroller | OLED表示ライブラリ | - |

##### メソッド一覧

| メソッド | 引数 | 戻り値 | 説明 |
|----------|------|--------|------|
| `__init__` | なし | None | 初期化（API/OLED設定読み込み） |
| `get_weather_data` | なし | Optional[Dict] | OpenWeatherMap APIから天気取得 |
| `generate_outfit_advice` | weather_data: Dict | str | GPT-5-miniで服装アドバイス生成 |
| `format_display_text` | weather_data: Dict, outfit_advice: str | str | OLED表示用テキスト整形 |
| `display_scrolling_text` | text: str, loop_count: int=3 | None | OLEDにスクロール表示 |
| `run` | loop_count: int=3 | None | メイン処理実行 |

---

### 4.2 scroll_oled.py（ライブラリ）

#### OLEDScroller クラス

| 項目 | 内容 |
|------|------|
| 責務 | SSD1306 OLEDへの日本語テキスト横スクロール表示 |
| 出典 | reference/06-004-ssd1306-oled-jp-display |
| 依存 | luma.oled, Pillow |

##### コンストラクタ

```python
OLEDScroller(
    font_path: str = FONT_PATH,      # フォントファイルパス
    font_size: int = FONT_SIZE,      # フォントサイズ (default: 16)
    width: int = WIDTH,              # 画面幅 (default: 128)
    height: int = HEIGHT,            # 画面高さ (default: 64)
    address: int = I2C_ADDRESS       # I²Cアドレス (default: 0x3C)
)
```

##### メソッド一覧

| メソッド | 引数 | 戻り値 | 説明 |
|----------|------|--------|------|
| `scroll` | text: str, speed: int=2, delay: float=0.05, loops: int=None, y_pos: int=24 | None | テキスト横スクロール表示 |
| `clear` | なし | None | 画面クリア |

---

## 5. 処理フロー

### 5.1 メイン処理シーケンス

```
┌─────────┐     ┌──────────────────┐     ┌─────────────┐     ┌──────────┐
│  main() │     │WeatherOutfitAdv. │     │ External API│     │OLEDScroll│
└────┬────┘     └────────┬─────────┘     └──────┬──────┘     └────┬─────┘
     │                   │                      │                  │
     │ インスタンス生成   │                      │                  │
     │──────────────────>│                      │                  │
     │                   │                      │                  │
     │                   │ OLEDScroller初期化   │                  │
     │                   │─────────────────────────────────────────>│
     │                   │                      │                  │
     │ run()             │                      │                  │
     │──────────────────>│                      │                  │
     │                   │                      │                  │
     │                   │ 天気データ取得       │                  │
     │                   │─────────────────────>│                  │
     │                   │<─────────────────────│                  │
     │                   │                      │                  │
     │                   │ 服装アドバイス生成   │                  │
     │                   │─────────────────────>│                  │
     │                   │<─────────────────────│                  │
     │                   │                      │                  │
     │                   │ テキスト整形         │                  │
     │                   │─────────────────────>│                  │
     │                   │                      │                  │
     │                   │ スクロール表示       │                  │
     │                   │─────────────────────────────────────────>│
     │                   │                      │                  │
     │                   │ 画面クリア           │                  │
     │                   │─────────────────────────────────────────>│
     │                   │                      │                  │
     │<──────────────────│                      │                  │
     │                   │                      │                  │
```

### 5.2 run() メソッド詳細フロー

```
開始
  │
  ▼
[ステップ1] 天気データ取得
  │ get_weather_data()
  │
  ├─ 失敗 ─→ エラーメッセージ表示 → 終了
  │
  ▼
[ステップ2] 服装アドバイス生成
  │ generate_outfit_advice(weather_data)
  │
  ▼
[ステップ3] 表示テキスト整形
  │ format_display_text(weather_data, advice)
  │ 形式: "都市名: 気温°C 天気 | アドバイス"
  │
  ▼
[ステップ4] OLEDスクロール表示
  │ display_scrolling_text(text, loop_count)
  │ → self.scroller.scroll()
  │
  ▼
[ステップ5] 画面クリア
  │ self.scroller.clear()
  │
  ▼
終了
```

---

## 6. 外部API仕様

### 6.1 OpenWeatherMap API

| 項目 | 内容 |
|------|------|
| エンドポイント | `https://api.openweathermap.org/data/2.5/weather` |
| メソッド | GET |
| タイムアウト | 10秒 |

#### リクエストパラメータ

| パラメータ | 値 | 説明 |
|------------|-----|------|
| `q` | 都市名 | 例: Tokyo, Osaka |
| `appid` | APIキー | 環境変数から取得 |
| `units` | metric | 摂氏温度 |
| `lang` | ja | 日本語レスポンス |

#### 使用レスポンスフィールド

| フィールド | 用途 |
|------------|------|
| `main.temp` | 気温（摂氏） |
| `main.feels_like` | 体感温度 |
| `main.humidity` | 湿度（%） |
| `weather[0].description` | 天気説明（日本語） |
| `name` | 都市名 |

### 6.2 OpenAI API

| 項目 | 内容 |
|------|------|
| モデル | gpt-5-mini |
| パラメータ | `max_completion_tokens=1000` |
| 平均推論トークン | 約427トークン |

#### プロンプト構造

```
システム: あなたは天気に基づいた服装アドバイザーです。
         簡潔で実用的なアドバイスを提供してください。

ユーザー: 今日の天気情報：
         - 気温: {temp}°C
         - 体感温度: {feels_like}°C
         - 湿度: {humidity}%
         - 天気: {description}

         上記の天気情報を基に、今日の服装アドバイスを
         日本語で簡潔に(50文字以内で)提案してください。
```

---

## 7. 環境変数仕様

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| `WEATHER_API_KEY` | ○ | - | OpenWeatherMap APIキー |
| `OPENAI_API_KEY` | ○ | - | OpenAI APIキー |
| `CITY_NAME` | - | Tokyo | 対象都市名 |
| `OLED_WIDTH` | - | 128 | OLED画面幅 |
| `OLED_HEIGHT` | - | 64 | OLED画面高さ |
| `OLED_I2C_ADDRESS` | - | 0x3C | I²Cアドレス |
| `FONT_PATH` | - | ./assets/fonts/NotoSansCJKjp-Regular.otf | フォントパス |
| `FONT_SIZE` | - | 14 | フォントサイズ |
| `SCROLL_SPEED_PX` | - | 2 | スクロール速度 |
| `FRAME_DELAY_SEC` | - | 0.05 | フレーム間隔 |

---

## 8. エラーハンドリング

### 8.1 エラー種別と対応

| エラー種別 | 発生箇所 | 対応 |
|------------|----------|------|
| APIキー未設定 | `__init__` | ValueError発生 |
| OLED初期化失敗 | `__init__` | scroller=None、ログ出力 |
| 天気API通信エラー | `get_weather_data` | None返却、ログ出力 |
| OpenAI APIエラー | `generate_outfit_advice` | エラーメッセージ返却 |
| スクロール表示エラー | `display_scrolling_text` | ログ出力、処理継続 |

### 8.2 OLED利用不可時の動作

OLEDが初期化できない場合（`self.scroller = None`）:
- 表示予定テキストをログに出力
- エラーなく処理を完了

---

## 9. ライブラリ参照形式への変更履歴

### 9.1 変更概要（v1.0 → v2.0）

| 項目 | v1.0（従来） | v2.0（現行） |
|------|-------------|-------------|
| OLED初期化 | 自前実装（I²C, ssd1306, フォント） | OLEDScroller クラス |
| スクロール処理 | 自前ループ実装（約40行） | scroller.scroll() |
| コード行数 | 371行 | 307行（-17%） |
| 依存インポート | luma.core, luma.oled, PIL | scroll_oled.OLEDScroller |

### 9.2 変更詳細

#### インポート部分
```python
# v1.0（従来）
from luma.core.interface.serial import i2c
from luma.oled.device import ssd1306
from PIL import Image, ImageDraw, ImageFont

# v2.0（現行）
from scroll_oled import OLEDScroller
```

#### OLED初期化
```python
# v1.0（従来）約30行
serial = i2c(port=1, address=self.oled_i2c_address)
self.oled = ssd1306(serial, width=..., height=...)
self.font = ImageFont.truetype(...)

# v2.0（現行）約10行
self.scroller = OLEDScroller(
    font_path=self.font_path,
    font_size=self.font_size,
    width=self.oled_width,
    height=self.oled_height,
    address=self.oled_i2c_address
)
```

#### スクロール表示
```python
# v1.0（従来）約40行のループ処理
while loop_counter < loop_count:
    image = Image.new("1", ...)
    draw = ImageDraw.Draw(image)
    draw.text((x_position, margin_y), text, ...)
    self.oled.display(image)
    x_position -= speed
    ...

# v2.0（現行）1行
self.scroller.scroll(text, speed=..., delay=..., loops=...)
```

---

## 10. 現在の機能一覧（v2.0）

### 10.1 機能カテゴリ別一覧

#### A. 初期化機能

| No | 機能名 | 行数 | 説明 | MVP判定 |
|----|--------|------|------|---------|
| A1 | 環境変数読み込み | 8行 | .envからAPIキー・設定読み込み | 必須 |
| A2 | APIキー検証 | 4行 | 未設定時にValueError発生 | 必須 |
| A3 | OLED設定読み込み | 4行 | 画面サイズ・I²Cアドレス設定 | 検討 |
| A4 | フォント設定読み込み | 2行 | パス・サイズ設定 | 検討 |
| A5 | スクロール設定読み込み | 2行 | 速度・間隔設定 | 検討 |
| A6 | OpenAIクライアント初期化 | 1行 | APIクライアント生成 | 必須 |
| A7 | OLEDScroller初期化 | 10行 | ライブラリ初期化＋エラー処理 | 必須 |

#### B. 天気情報取得機能

| No | 機能名 | 行数 | 説明 | MVP判定 |
|----|--------|------|------|---------|
| B1 | APIエンドポイント設定 | 1行 | OpenWeatherMap URL | 必須 |
| B2 | リクエストパラメータ構築 | 6行 | 都市名・APIキー・単位・言語 | 必須 |
| B3 | HTTP GET実行 | 4行 | requests.get + タイムアウト | 必須 |
| B4 | エラーハンドリング | 3行 | RequestException捕捉＋ログ | 検討 |

#### C. 服装アドバイス生成機能

| No | 機能名 | 行数 | 説明 | MVP判定 |
|----|--------|------|------|---------|
| C1 | 天気データ抽出 | 4行 | 気温・体感温度・湿度・天気説明 | 必須 |
| C2 | プロンプト構築 | 10行 | 天気情報を含むプロンプト生成 | 必須 |
| C3 | OpenAI API呼び出し | 8行 | chat.completions.create | 必須 |
| C4 | レスポンス解析 | 1行 | choices[0].message.content抽出 | 必須 |
| C5 | トークン使用ログ | 8行 | 総/入力/出力/推論トークン記録 | 削除候補 |
| C6 | エラーハンドリング | 3行 | Exception捕捉＋ログ | 検討 |

#### D. テキスト整形機能

| No | 機能名 | 行数 | 説明 | MVP判定 |
|----|--------|------|------|---------|
| D1 | 天気データ抽出 | 3行 | 気温・天気説明・都市名 | 必須 |
| D2 | 表示テキスト生成 | 1行 | フォーマット文字列 | 必須 |
| D3 | エラー時テキスト | 2行 | 取得失敗時の代替文字列 | 検討 |

#### E. OLED表示機能

| No | 機能名 | 行数 | 説明 | MVP判定 |
|----|--------|------|------|---------|
| E1 | OLED利用可否判定 | 3行 | scroller存在チェック | 必須 |
| E2 | スクロール実行 | 5行 | scroller.scroll()呼び出し | 必須 |
| E3 | スクロール開始ログ | 2行 | 設定値のログ出力 | 削除候補 |
| E4 | KeyboardInterrupt処理 | 2行 | Ctrl+C時の画面クリア | 検討 |
| E5 | エラーハンドリング | 2行 | Exception捕捉＋ログ | 検討 |

#### F. メイン処理機能（run）

| No | 機能名 | 行数 | 説明 | MVP判定 |
|----|--------|------|------|---------|
| F1 | 開始ログ | 1行 | "Starting..."ログ | 削除候補 |
| F2 | 天気取得呼び出し | 2行 | get_weather_data() | 必須 |
| F3 | 天気取得失敗処理 | 6行 | エラー表示＋ログ＋return | 検討 |
| F4 | アドバイス生成呼び出し | 2行 | generate_outfit_advice() | 必須 |
| F5 | テキスト整形呼び出し | 2行 | format_display_text() | 必須 |
| F6 | 表示テキストログ | 1行 | 生成テキストのログ | 削除候補 |
| F7 | スクロール表示呼び出し | 1行 | display_scrolling_text() | 必須 |
| F8 | 終了処理 | 2行 | scroller.clear() | 必須 |
| F9 | 完了ログ | 1行 | "完了"ログ | 削除候補 |

#### G. エントリーポイント（main）

| No | 機能名 | 行数 | 説明 | MVP判定 |
|----|--------|------|------|---------|
| G1 | インスタンス生成 | 1行 | WeatherOutfitAdvisor() | 必須 |
| G2 | run実行 | 1行 | advisor.run() | 必須 |
| G3 | KeyboardInterrupt処理 | 2行 | Ctrl+C時のログ | 検討 |
| G4 | 汎用Exception処理 | 3行 | エラーログ＋sys.exit | 検討 |

#### H. 共通機能

| No | 機能名 | 行数 | 説明 | MVP判定 |
|----|--------|------|------|---------|
| H1 | ログ設定 | 8行 | ファイル+コンソール出力 | 削除候補 |
| H2 | ImportErrorハンドリング | 4行 | ライブラリ未インストール対応 | 検討 |
| H3 | 型ヒント | - | Optional, Dict, Any | 削除候補 |
| H4 | docstring（クラス） | 3行 | クラス説明 | 簡略化 |
| H5 | docstring（メソッド） | 各5-8行 | 引数・戻り値説明 | 簡略化 |
| H6 | インラインコメント | 各所 | 処理説明コメント | 簡略化 |

---

### 10.2 現在のコード統計

| 項目 | 値 |
|------|-----|
| 総行数 | 307行 |
| クラス数 | 1（WeatherOutfitAdvisor） |
| メソッド数 | 6（__init__, get_weather_data, generate_outfit_advice, format_display_text, display_scrolling_text, run） |
| 関数数 | 1（main） |
| 環境変数数 | 10項目 |
| ログ出力箇所 | 18箇所 |
| try-except箇所 | 6箇所 |
| docstring行数 | 約50行 |
| コメント行数 | 約40行 |

---

### 10.3 MVP化検討サマリ

| カテゴリ | 必須 | 検討 | 削除候補 | 簡略化 |
|----------|------|------|----------|--------|
| A. 初期化 | 4 | 3 | 0 | 0 |
| B. 天気取得 | 3 | 1 | 0 | 0 |
| C. アドバイス生成 | 4 | 1 | 1 | 0 |
| D. テキスト整形 | 2 | 1 | 0 | 0 |
| E. OLED表示 | 2 | 2 | 1 | 0 |
| F. メイン処理 | 5 | 1 | 4 | 0 |
| G. エントリーポイント | 2 | 2 | 0 | 0 |
| H. 共通機能 | 0 | 1 | 3 | 3 |
| **合計** | **22** | **12** | **9** | **3** |

#### 削減見込み
- **削除候補（9項目）**: ログ出力・トークン記録等 → 約30-40行削減見込み
- **簡略化（3項目）**: docstring・コメント → 約50-60行削減見込み
- **検討項目（12項目）**: 一部固定化・簡素化で追加削減可能

---

## 11. MVP版 削減対象機能一覧

### 11.1 削除する機能

以下の機能はMVP版では**完全に削除**する。

| No | 機能名 | 現在の行数 | 削除理由 |
|----|--------|-----------|----------|
| C5 | トークン使用ログ | 8行 | デバッグ用途。書籍サンプルでは不要 |
| E3 | スクロール開始ログ | 2行 | 冗長なログ出力 |
| F1 | 開始ログ | 1行 | 冗長なログ出力 |
| F6 | 表示テキストログ | 1行 | 冗長なログ出力 |
| F9 | 完了ログ | 1行 | 冗長なログ出力 |
| H1 | ログ設定（logging） | 8行 | print()に置き換え |
| H3 | 型ヒント（typing） | 1行+各所 | 初心者向けに省略 |

**削除による削減: 約25行**

---

### 11.2 簡略化する機能

以下の機能はMVP版では**簡略化**する。

| No | 機能名 | 現在 | MVP版 | 削減行数 |
|----|--------|------|-------|---------|
| H4 | docstring（クラス） | 3行 | 1行 | 2行 |
| H5 | docstring（メソッド） | 各5-8行 | 各1行 | 約30行 |
| H6 | インラインコメント | 各所40行 | 必要最小限10行 | 約30行 |

**簡略化による削減: 約60行**

---

### 11.3 固定化・統合する機能

以下の機能はMVP版では**固定値化または統合**する。

| No | 機能名 | 現在の実装 | MVP版の実装 | 削減行数 |
|----|--------|-----------|-------------|---------|
| A3 | OLED設定読み込み | 環境変数4行 | 定数化2行 | 2行 |
| A4 | フォント設定読み込み | 環境変数2行 | 定数化1行 | 1行 |
| A5 | スクロール設定読み込み | 環境変数2行 | 定数化1行 | 1行 |
| A7 | OLEDScroller初期化 | try-except 10行 | シンプル化5行 | 5行 |
| B4 | 天気取得エラー処理 | ログ出力3行 | print 1行 | 2行 |
| C6 | アドバイス生成エラー処理 | ログ出力3行 | print 1行 | 2行 |
| D3 | エラー時テキスト | 関数内2行 | 維持 | 0行 |
| E4 | KeyboardInterrupt処理 | 2行 | 削除 | 2行 |
| E5 | OLED表示エラー処理 | 2行 | 削除 | 2行 |
| F3 | 天気取得失敗処理 | 6行 | 3行 | 3行 |
| G3 | KeyboardInterrupt処理 | 2行 | 削除 | 2行 |
| G4 | 汎用Exception処理 | 3行 | 2行 | 1行 |
| H2 | ImportErrorハンドリング | 4行 | 2行 | 2行 |

**固定化・統合による削減: 約25行**

---

### 11.4 MVP版で維持する必須機能

以下の機能はMVP版でも**そのまま維持**する。

| カテゴリ | 機能 |
|----------|------|
| 初期化 | 環境変数読み込み（APIキー、都市名）、APIキー検証、OpenAIクライアント初期化、OLEDScroller初期化 |
| 天気取得 | APIエンドポイント、リクエストパラメータ構築、HTTP GET実行 |
| アドバイス生成 | 天気データ抽出、プロンプト構築、OpenAI API呼び出し、レスポンス解析 |
| テキスト整形 | 天気データ抽出、表示テキスト生成 |
| OLED表示 | OLED利用可否判定、スクロール実行 |
| メイン処理 | 天気取得→アドバイス生成→テキスト整形→スクロール表示→画面クリア |
| エントリーポイント | インスタンス生成、run実行 |

---

### 11.5 削減効果サマリ（計画）

| 削減種別 | 削減行数 |
|----------|---------|
| 削除する機能 | 約25行 |
| 簡略化する機能 | 約60行 |
| 固定化・統合する機能 | 約25行 |
| **合計削減** | **約110行** |

| 項目 | 現在 | MVP版目標 |
|------|------|-----------|
| 総行数 | 307行 | **約200行以下** |
| ログ出力箇所 | 18箇所 | 0箇所（print使用） |
| try-except箇所 | 6箇所 | 2-3箇所 |
| docstring行数 | 約50行 | 約10行 |
| コメント行数 | 約40行 | 約10行 |
| 環境変数数 | 10項目 | 3項目（APIキー×2、都市名） |

---

### 11.6 MVP版リファクタリング実績

#### 実施日
2025年12月30日

#### 削減結果

| 項目 | v2.0（リファクタリング前） | v3.0 MVP版 | 削減数 | 削減率 |
|------|---------------------------|------------|--------|--------|
| **総行数** | 307行 | **137行** | 170行 | **55%** |
| クラス数 | 1 | 1 | - | - |
| メソッド数 | 6 | 4 | 2 | 33% |
| 関数数 | 1 | 1 | - | - |
| 環境変数数 | 10項目 | 3項目 | 7項目 | 70% |
| try-except箇所 | 6箇所 | 3箇所 | 3箇所 | 50% |

#### 実施した変更一覧

| 変更内容 | 詳細 |
|----------|------|
| logging削除 | `logging`モジュール→`print()`に置換（8行削減） |
| 型ヒント削除 | `Optional[Dict[str, Any]]`等を削除（1行+各所） |
| 環境変数を定数化 | OLED/フォント/スクロール設定を定数化（8行削減） |
| docstring簡略化 | 各メソッド1行に短縮（約40行削減） |
| コメント削減 | 必要最小限のコメントのみ（約30行削減） |
| エラー処理簡素化 | 詳細なヒント削除、シンプルなprint（約15行削減） |
| トークンログ削除 | GPT-5推論トークン記録を完全削除（8行削減） |
| メソッド統合 | `format_display_text`と`display_scrolling_text`を`run`に統合（約30行削減） |

#### 削除したメソッド

| メソッド名 | 理由 |
|------------|------|
| `format_display_text` | `run`メソッド内に統合 |
| `display_scrolling_text` | `run`メソッド内に統合 |

---

### 11.7 MVP版コード構造（実装済み）

```
weather_outfit_advisor.py (137行)
│
├── ヘッダー・インポート (1-12行: 12行)
│   ├── シバン・docstring
│   └── import文 (os, sys, requests, openai, dotenv, scroll_oled)
│
├── 設定定数 (14-21行: 8行)
│   ├── FONT_PATH, FONT_SIZE
│   ├── OLED_WIDTH, OLED_HEIGHT, I2C_ADDRESS
│   └── SCROLL_SPEED, FRAME_DELAY
│
├── WeatherOutfitAdvisor クラス (26-123行: 98行)
│   ├── __init__ (29-52行: 24行)
│   │   ├── APIキー取得・検証
│   │   ├── OpenAIクライアント初期化
│   │   └── OLEDScroller初期化
│   │
│   ├── get_weather_data (54-70行: 17行)
│   │   └── OpenWeatherMap API呼び出し
│   │
│   ├── generate_outfit_advice (72-97行: 26行)
│   │   ├── 天気データ抽出
│   │   ├── プロンプト構築
│   │   └── OpenAI API呼び出し
│   │
│   └── run (99-123行: 25行)
│       ├── 天気データ取得
│       ├── 服装アドバイス生成
│       ├── 表示テキスト作成
│       └── OLEDスクロール表示
│
└── main関数・エントリーポイント (126-137行: 12行)
```

---

## 12. 関連ドキュメント

| 文書名 | 説明 |
|--------|------|
| 09-003_要件定義書.md | 機能要件・非機能要件 |
| CLAUDE.md | 開発ルールファイル |
| COMMENT_STYLE_GUIDE.md | コメント記載標準 |
| TROUBLESHOOTING.md | トラブルシューティング |
| README.md | セットアップ・使用方法 |

---

## 改訂履歴

| 版数 | 日付 | 変更内容 |
|------|------|----------|
| 1.0 | 2025-10-28 | 初版作成 |
| 2.0 | 2025-12-30 | ライブラリ参照形式へリファクタリング |
| 2.1 | 2025-12-30 | 機能一覧・MVP化検討セクション追加 |
| 2.2 | 2025-12-30 | MVP版削減対象機能一覧を追加 |
| 3.0 | 2025-12-30 | MVP版リファクタリング実施（307行→137行） |
